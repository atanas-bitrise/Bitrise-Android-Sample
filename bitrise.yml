---
format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: android
trigger_map:
- push_branch: "*"
  workflow: emulator
- pull_request_source_branch: "*"
  workflow: emulator
workflows:
  emulator:
    steps:
    - script@1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x
            # /usr/local/share/android-sdk/emulator/emulator "@emulator" -version
            echo $ANDROID_HOME
            echo $ANDROID_SDK_ROOT
            printenv
            envman add --key ANDROID_HOME --value '/usr/local/share/android-sdk'
            envman add --key ANDROID_SDK_ROOT --value '/usr/local/share/android-sdk'
    - git::https://github.com/DamienBitrise/steps-avd-manager.git@master:
        inputs:
        - api_level: '29'
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@6: {}
    - install-missing-android-tools@2:
        inputs:
        - gradlew_path: "$PROJECT_LOCATION/gradlew"
    - android-build-for-ui-testing@0:
        inputs:
        - variant: debug
        - module: app
    - wait-for-android-emulator@1: {}
    - script@1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x

            /usr/local/share/android-sdk/emulator/emulator "@emulator" -accel-check
    - gradle-runner@1:
        inputs:
        - gradle_file: "$BITRISE_SOURCE_DIR/app/build.gradle"
        - gradlew_path: "$GRADLEW_PATH"
        - gradle_task: connectAndroidTest
    - deploy-to-bitrise-io@1:
        inputs:
        - notify_user_groups: none
app:
  envs:
  - opts:
      is_expand: false
    PROJECT_LOCATION: "."
  - opts:
      is_expand: false
    MODULE: app
  - opts:
      is_expand: false
    VARIANT: ''
  - opts:
      is_expand: false
    GRADLEW_PATH: "./gradlew"
meta:
  bitrise.io:
    machine_type_id: elite
